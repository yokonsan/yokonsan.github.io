<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="yokonsan" />
	
	
	
	<title>Ubuntu&#43;uwsgi&#43;Nginx部署Flask应用 ｜ 乾之 三爻</title>
	
    
    
    <meta name="description" content="由于是第一次在Linux部署Python应用，过程中遇到很多坑，也找了很多部署博客的分享。再一次体会到好文章带你上天堂，坏文章带你瞎逼忙的道理。索性就记录这次部署的全过程，供以后参考。 介绍 首先先介绍下" />
    

    
    
    <meta name="keywords" content="技术, 生活, 分享" />
    

	
    
    <link rel="shortcut icon" href="https://yokonsan.github.io/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://yokonsan.github.io/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://yokonsan.github.io/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://yokonsan.github.io/css/highlight.css" />

    
    
</head>

<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://yokonsan.github.io/">
                    <span>乾之 三爻</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">yokon&#39;s blog</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/yokonsan" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                <a href="https://yokonsan.github.io/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2017/12/ubuntu-nginx-uwsgi-flask-app/'>Ubuntu&#43;uwsgi&#43;Nginx部署Flask应用</a></h2>
                        <span class="date">2017.12.12</span>
                    </div>
                    <div class="post_content markdown"><p>由于是第一次在<code>Linux</code>部署<code>Python</code>应用，过程中遇到很多坑，也找了很多部署博客的分享。再一次体会到<strong>好文章带你上天堂，坏文章带你瞎逼忙</strong>的道理。索性就记录这次部署的全过程，供以后参考。</p>
<h2 id="介绍">介绍</h2>
<p>首先先介绍下各个技术的功能，以及他们组合的大致流程。部署的是一个web应用，从用户打开浏览器访问网页开始，到浏览到网页内容，这个过程就是各个技术实现功能的过程。</p>
<h3 id="整体结构">整体结构</h3>
<ul>
<li>用户浏览器（客户端）打开网页，向服务器发起请求；</li>
<li>请求传给Nginx服务器，Nginx将请求发给uWSGI;</li>
<li>uWSGI服务器发来的请求翻译为应用程序理解的形式，发给应用；</li>
<li>Flask应用接收请求并处理，将响应结果发给uWSGI；</li>
<li>uWSGI与Nginx服务器通信，将结果传给他；</li>
<li>Nginx服务器收到响应结果，将其传给客户端；</li>
<li>浏览器显示响应结果，并进行下一个请求。</li>
</ul>
<h2 id="安装python环境">安装Python环境</h2>
<p>阿里云<code>Ubuntu</code>服务器自带的<code>Python2.7</code>和<code>Python3.4</code>，所以尽管我的应用是<code>Python3</code>程序，也不必重新装<code>Python3</code>。</p>
<h3 id="更新apt-get软件源">更新apt-get软件源</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo apt-get update
</span></span></code></pre></div><h3 id="获取应用源码">获取应用源码</h3>
<p>由于我的代码放在github仓库，直接通过git来安装。首先安装git：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo apt-get install git
</span></span></code></pre></div><p>安装完成后，在用户目录中新建<code>project</code>目录<code>mkdir project</code>，存放我们的应用程序。不知道是不是在用户目录可以输入指令<code>pwd</code>查看。我们转到<code>project</code>文件夹下，使用<code>git</code>克隆项目源码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">git clone https://github.com/Blackyukun/YuBlog.git
</span></span></code></pre></div><p>转到项目目录<code>cd YuBlog</code></p>
<h3 id="安装pip和virtualenv">安装pip和virtualenv</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo apt-get install python-pip
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">sudo apt-get install python-virtualenv
</span></span></code></pre></div><h3 id="创建虚拟环境">创建虚拟环境</h3>
<p>这里需要注意的是，如果直接<code>virtualenv venv</code>命令，创建的将会是<code>Python2</code>的虚拟环境。如果想要创建<code>Python3</code>的环境，需要指定<code>Python3</code>的目录：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">virtualenv -p /usr/bin/python3 venv
</span></span></code></pre></div><p>如果成功，项目目录下会生成一个<code>venv</code>目录，那里就是我们的<code>python3</code>虚拟环境了。接下来激活虚拟环境：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">source venv/bin/activate
</span></span></code></pre></div><p>退出虚拟环境命令是：<code>deactivate </code></p>
<h3 id="安装依赖包">安装依赖包</h3>
<p>如果项目实在虚拟环境中完成的，那么通常我们会使用<code>pip freeze &gt;requirements.txt</code>命令列出项目所有依赖。然后当我们安装这些依赖的时候只需要使用命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pip install -i http://pypi.douban.com/simple/ -r requirements.txt
</span></span></code></pre></div><p>如果全部安装完成，那么我们的程序依赖环境全都准备好了。</p>
<h2 id="安装mysql数据库">安装Mysql数据库</h2>
<p>我的程序是使用<code>Mysql</code>数据库做存储的，安装它也很简单，但是这里会有一个阿里云服务器的大坑。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo apt-get install mysql-server mysql-client
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">sudo apt-get install libmysqlclient-dev
</span></span></code></pre></div><p>安装过程中会需要你输入用户以及密码，暂且就使用<code>root</code>和<code>password</code>吧。</p>
<p><code>sudo netstat -tap | grep mysql</code>命令检查<code>Mysql</code>是否安装成功，如果<code>mysql</code>的<code>socke</code>t处于<code>listen</code>状态则表示安装成功。</p>
<p>登录mysql数据库命令：<code>mysql -u root -p</code>这里的<code>root</code>就是之前安装是设置的用户名，接着输入密码<code>password</code>。在<code>Linux</code>上，我们需要修改<code>mysql</code>的默认编码为<code>utf-8</code>，以便正确地处理中文。</p>
<p>这里需要编辑<code>MySQL</code>的配置文件，把数据库默认的编码全部改为<code>UTF-8</code>。<code>MySQL</code>的配置文件默认存放在<code>/etc/my.cnf</code>或者<code>/etc/mysql/my.cnf</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vim /etc/mysql/my.cnf 
</span></span></code></pre></div><p>linux使用的是<code>vim</code>编辑器，不了解<code>vim</code>的可以自行了解。我们按<code>i</code>进去插入模式，将下面的指令粘贴到对应位置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[client]
</span></span><span class="line"><span class="cl">default-character-set = utf8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[mysqld]
</span></span><span class="line"><span class="cl">default-storage-engine = INNODB
</span></span><span class="line"><span class="cl">character-set-server = utf8
</span></span><span class="line"><span class="cl">collation-server = utf8_general_ci
</span></span></code></pre></div><p>把队应指令放在对应地方就好了。配置完成后，在<code>vim</code>编辑器下，按<code>ESC</code>进入普通模式，键入<code>:wq</code>进行保存并退出。<code>show variables like '%char%';</code>指令查看编码是否设置正确。如果看到utf8就表示正确。</p>
<p><img src="/image/post12/post12_1.png" alt="post12_1.png"></p>
<p>接着重启数据库：</p>
<pre><code>service mysql restart
</code></pre>
<p>重新登录<code>mysql -u root -p </code>创建我们的数据库，使用：<code>create database mydb;</code>创建名为<code>mydb</code>的库名（注意后面封号）。</p>
<h3 id="中文乱码">中文乱码</h3>
<p>这里我们会遇到一个坑，就是在后面程序启动保存数据的时候会出现中文乱码，但是我们明明已经编辑过默认编码了呀。这里我发现是阿里云服务器本身没有安装中文包，我们需要进行安装。</p>
<h4 id="安装中文语言包">安装中文语言包</h4>
<pre><code>sudo apt-get -y install language-pack-zh-hans
</code></pre>
<h4 id="修改语言环境设置">修改语言环境设置</h4>
<pre><code>echo &quot;LC_ALL=zh_CN.utf8&quot; &gt;&gt; /etc/profile

echo &quot;export LC_ALL&quot; &gt;&gt; /etc/profile
</code></pre>
<h4 id="查看语言">查看语言</h4>
<pre><code>source /etc/profile

locale
</code></pre>
<p>看到<code>zh_CN.UTF-8</code>就成功了。接着需要重启服务器。</p>
<h3 id="根本原因">根本原因</h3>
<p>虽然中文包安装成功了，但是这样就表示ok了吗？并没有，后来启动中网页中文显示依然乱码。我发现是保存数据库里的数据才会乱码，那么根本原因还是数据库编码问题。</p>
<p>我们需要在创建数据库时要同时定义他的默认编码：</p>
<p>删除数据库：<code>mysql&gt;delete database mydb;</code></p>
<p>创建数据库：<code>mysql&gt;create database mydb default character set utf8;</code></p>
<h2 id="安装nginx服务器">安装Nginx服务器</h2>
<p>Nginx是一款轻量级的Web服务器/反向代理服务器及电子邮件<code>IMAP/POP3</code>代理服务器。其特点是占有内存少，并发能力强。用于接收HTTP请求并返回响应。安装：</p>
<pre><code>sudo apt-get install nginx
</code></pre>
<p>启动：<code>sudo /etc/init.d/nginx start</code></p>
<p>看到OK表示成功。接着需要配置<code>Nginx</code>。<code>Nginx</code>的配置文件在<code>/etc/nginx/sites-available</code>目录的<code>default</code>文件中，将其删除<code>rm default</code>。新的<code>default</code>创建并打开<code>vim default</code>，在里面写入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server { 
</span></span><span class="line"><span class="cl">  listen 80; # 80端口需要打开
</span></span><span class="line"><span class="cl">  server_name X.X.X.X; #阿里云公网ip
</span></span><span class="line"><span class="cl">  location / { 
</span></span><span class="line"><span class="cl">  include uwsgi_params;
</span></span><span class="line"><span class="cl">  uwsgi_pass 127.0.0.1:5000; # 指向uwsgi 所应用的内部地址
</span></span><span class="line"><span class="cl">  uwsgi_param UWSGI_PYHOME /home/root/project/YuBlog/venv; # 虚拟环境目录
</span></span><span class="line"><span class="cl">  uwsgi_param UWSGI_CHDIR /home/root/project/YuBlog; # 应用根目录
</span></span><span class="line"><span class="cl">  uwsgi_param UWSGI_SCRIPT manage:app; # 启动程序
</span></span><span class="line"><span class="cl">  uwsgi_read_timeout 100; 
</span></span><span class="line"><span class="cl"> }  
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>重启Nginx：<code>sudo service nginx restart</code></p>
<p>看到OK表示成功。如果失败，可以输入指令<code>sudo nginx -t</code>查找错误，进行处理。</p>
<h2 id="安装uwsgi">安装uWSGI</h2>
<p><code>uWSGI</code>虽然也可以起到Web服务器的作用，那么为什么有了<code>uWSGI</code>还需要<code>Nginx</code>呢。具体的优势大家自行了解。在<code>Nginx+uWSGI</code>的结构中，它充当中间件的程序，是Web的通信协议。</p>
<p>安装：<code>sudo pip install uwsgi</code></p>
<p>注意实在虚拟环境。安装成功后需要配置。我们在项目的根目录下也就是<code>/home/root/project/YuBlog</code>下，创建配置文件<code>config.ini</code>，添加内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[uwsgi]
</span></span><span class="line"><span class="cl">master = true
</span></span><span class="line"><span class="cl">home = venv
</span></span><span class="line"><span class="cl">wsgi-file = manage.py
</span></span><span class="line"><span class="cl">callable = app
</span></span><span class="line"><span class="cl">socket = :5000
</span></span><span class="line"><span class="cl">processes = 4
</span></span><span class="line"><span class="cl">threads = 2
</span></span></code></pre></div><p>配置完成后，就可以启动<code>uWSGI</code>了。但在这之前，我们先启动应用程序，并添加程序必须的环境变量。</p>
<p>添加<code>linux</code>系统环境变量：<code>export CONFIG=production</code></p>
<p>&hellip;</p>
<p>先创建迁移仓库：<code>python manage.py db init</code></p>
<p>创建迁移脚本，<code>migrate</code>子命令用来自动创建：<code>python manage.py db migrate -m &quot;v1.0&quot;</code></p>
<p>更新数据库操作：<code>python manage.py db upgrade</code></p>
<p>创建管理员信息：<code>python manage.py addAdmin</code></p>
<p><code>ctrl+c</code>终止程序。</p>
<p>启动<code>uWSGI</code>: <code>uwsgi config.ini</code></p>
<p>会看到很多信息，只要没有报错，就表明启动成功。</p>
<h2 id="部署成功">部署成功</h2>
<p>如果<code>Nginx</code>和<code>uWSGI</code>全部启动成功，就说明部署已经成功了。打开外部浏览器，访问公网<code>ip</code>地址，就可以看到我们的程序已经跑起来了。</p>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://yokonsan.github.io/tags/ubuntu/">ubuntu</a>
                                    
                                    <a href="https://yokonsan.github.io/tags/flask/">flask</a>
                                    
                                    <a href="https://yokonsan.github.io/tags/nginx/">nginx</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://varkai.com">Designed by VarKai,</a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
    </div>

    <div class="footer_slogan">
        <span>博观约取，厚积薄发</span>
    </div>
</footer>
    <script src="https://yokonsan.github.io/js/jquery-3.5.1.min.js"></script>
<link href="https://yokonsan.github.io/css/fancybox.min.css" rel="stylesheet">
<script src="https://yokonsan.github.io/js/fancybox.min.js"></script>
<script src="https://yokonsan.github.io/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



</body>

</html>