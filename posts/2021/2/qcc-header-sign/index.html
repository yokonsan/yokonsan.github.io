<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="yokonsan" />
	
	
	
	<title>企查查请求头反爬破解 ｜ 乾之 三爻</title>
	
    
    
    <meta name="description" content="最近有朋友问我，qcc 网站做了一次反爬措施，要如何破解。 分析 我抓包大致看了下，该模块下的请求为 ajax请求，并且每次请求都会带上一个疑似身份验证的请求头，长这个样子： 首先搜索网页 html 源码，无法得知该信息" />
    

    
    
    <meta name="keywords" content="技术, 生活, 分享" />
    

	
    
    <link rel="shortcut icon" href="https://yokonsan.com/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://yokonsan.com/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://yokonsan.com/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://yokonsan.com/css/highlight.css" />

    
    
</head>

<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/links/">Links</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://yokonsan.com/">
                    <span>乾之 三爻</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">yokon&#39;s blog</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/yokonsan" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://chat.muyufirst.com" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                <a href="https://yokonsan.com/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2021/2/qcc-header-sign/'>企查查请求头反爬破解</a></h2>
                        <span class="date">2021.02.11</span>
                    </div>
                    <div class="post_content markdown"><p>最近有朋友问我，<a href="https://www.qcc.com/web/elib/newcompany">qcc</a> 网站做了一次反爬措施，要如何破解。</p>
<h2 id="分析">分析</h2>
<p>我抓包大致看了下，该模块下的请求为 <code>ajax</code>请求，并且每次请求都会带上一个疑似身份验证的请求头，长这个样子：</p>
<p><img src="/image/post41/post41_1.png" alt="post41_1"></p>
<p>首先搜索网页 <code>html</code> 源码，无法得知该信息从何来，前面的请求也没有带，基本上可以断定是 <code>js</code> 动态生成并带上请求头，和后端交互的。</p>
<p>既然确定了，就开始找找是哪段 <code>js</code> 代码。查看 <code>html</code> 代码，该页面只加载了几个 <code>js</code> 文件：</p>
<p><img src="/image/post41/post41_2.png" alt="post41_2"></p>
<p><img src="/image/post41/post41_3.png" alt="post41_3"></p>
<p>不出意外的话， <code>jquery</code> 可以先不管，那就先看下面的文件。搜索关键词 <code>newcompany</code> 可以大概确定就是它了。因为该网站为了防止别人前端做 <code>debug</code> ，在该 <code>js</code> 文件中加了大量的 <code>debug</code> 断点。这个时候我们可以使用抓包工具 <code>filder</code> 做本地代理，在网站加载请求该 <code>js</code> 文件时，使用本地文件返回给网站。这样就可以将原来的 <code>js</code> 文件中的断点代码全部删掉，方便正常的调试。</p>
<h2 id="调试">调试</h2>
<p><code>filder</code> 的 <code>AutoResponder</code> 标签，点击添加规则，将左侧该  <code>main.8a7cb6af.js</code>  文件拖到右边，如下图设置即可：</p>
<p><img src="/image/post41/post41_4.png" alt="post41_4"></p>
<p>接着刷新网页，便不会再有无限的断点了。这个时候就可以开始调试代码，找到请求头开始生成的位置，以及生成的逻辑。</p>
<p>前端调试很枯燥，根据关键词，一步一步往下走，可以看到关键代码，如下：</p>
<p><img src="/image/post41/post41_5.png" alt="post41_5"></p>
<p>关键代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nx">a</span><span class="p">.</span><span class="k">default</span><span class="p">)(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">,</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nx">o</span><span class="p">.</span><span class="k">default</span><span class="p">)(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">e</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">,</span>
</span></span></code></pre></div><p>翻译成人看的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="k">default</span><span class="p">)(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="k">default</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">e</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span>
</span></span></code></pre></div><p>跟着往前看调用栈，这里的 <code>e</code> 就是后面带上请求头的元素。那么这里的 <code>i</code> 和 <code>v</code> 就是我们需要的。
跟着往下走，看这两个值时如何生成的。</p>
<p><img src="/image/post41/post41_6.png" alt="post41_6"></p>
<p>上图即是关键逻辑，用来生成初始的值。这里翻译过来就是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="s1">&#39;/api/elib/getnewcompany?countycode=&amp;flag=&amp;industry=&amp;issortasc=false&amp;pagesize=20&amp;province=&amp;sortfield=startdate&amp;startdateend=&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">=</span> <span class="nx">e</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">t</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="nx">o</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">o</span><span class="o">&lt;</span><span class="nx">n</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">o</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">n</span><span class="p">[</span><span class="nx">o</span><span class="p">].</span><span class="nx">charCodeAt</span><span class="p">()</span> <span class="o">%</span> <span class="nx">a</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">i</span> <span class="o">+=</span> <span class="nx">a</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">codes</span><span class="p">[</span><span class="nx">r</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">i</span>
</span></span></code></pre></div><p>这里的 <code>a.default</code> 是固定值：</p>
<p><img src="/image/post41/post41_7.png" alt="post41_7"></p>
<p>这样的话，直接看最后返回的值：</p>
<p><img src="/image/post41/post41_8.png" alt="post41_8"></p>
<h3 id="python翻译">Python翻译</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">o</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;/api/elib/getnewcompany?countycode=&amp;flag=&amp;industry…ze=20&amp;province=&amp;sortfield=startdate&amp;startdateend=&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">t</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mi">0</span><span class="p">:</span> <span class="s2">&#34;W&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span><span class="p">:</span> <span class="s2">&#34;l&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">2</span><span class="p">:</span> <span class="s2">&#34;k&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">3</span><span class="p">:</span> <span class="s2">&#34;B&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">4</span><span class="p">:</span> <span class="s2">&#34;Q&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="p">:</span> <span class="s2">&#34;g&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">6</span><span class="p">:</span> <span class="s2">&#34;f&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">7</span><span class="p">:</span> <span class="s2">&#34;i&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">8</span><span class="p">:</span> <span class="s2">&#34;i&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">9</span><span class="p">:</span> <span class="s2">&#34;r&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">10</span><span class="p">:</span> <span class="s2">&#34;v&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">11</span><span class="p">:</span> <span class="s2">&#34;6&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">12</span><span class="p">:</span> <span class="s2">&#34;A&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">13</span><span class="p">:</span> <span class="s2">&#34;K&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">14</span><span class="p">:</span> <span class="s2">&#34;N&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">15</span><span class="p">:</span> <span class="s2">&#34;k&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">16</span><span class="p">:</span> <span class="s2">&#34;4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">17</span><span class="p">:</span> <span class="s2">&#34;L&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">18</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">19</span><span class="p">:</span> <span class="s2">&#34;8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_n</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">o</span><span class="p">])</span> <span class="o">%</span> <span class="n">_n</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="n">codes</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span></code></pre></div><p>输出的结果似乎和需要的不太一样，只能继续往下走==！。</p>
<h2 id="hmac">hmac</h2>
<p>到了下图的位置，该网站前端 <code>js</code> 生产请求的逻辑以经很清晰了，这里使用了 <code>Hmac</code> 算法，对上面生成的一串字符做了哈希处理。</p>
<p><img src="/image/post41/post41_9.png" alt="post41_9"></p>
<p><code>python</code> 标准库中实现了该算法，可以直接调用。</p>
<h2 id="总结">总结</h2>
<ol>
<li>QCC 网站该模块前端限制 debug，可通过 filder 设置代理替换网站加载的 js 文件</li>
<li>js 文件格式化后有 30w 行，搜索关键词，一步步往下调试，找到关键代码</li>
<li>需要知道 hmac 算法的存在，不要盲目往下调试</li>
</ol>
<p>完整代码可以参考：<a href="https://github.com/Blackyukun/qcc_header_sign">qcc_header_sign</a> </p>
<h2 id="声明">声明</h2>
<ul>
<li>本仓库发布的脚本，仅用于测试和学习研究，禁止用于商业用途，不能保证其合法性，准确性，完整性和有效性，请根据情况自行判断。</li>
<li>如果任何单位或个人认为该项目的脚本可能涉嫌侵犯其权利，则应及时通知并提供身份证明，所有权证明，将在收到认证文件后删除项目。</li>
</ul>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://yokonsan.com/tags/%E7%88%AC%E8%99%AB/">爬虫</a>
                                    
                                    <a href="https://yokonsan.com/tags/%E9%80%86%E5%90%91/">逆向</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://github.com/varkai/hugo-theme-zozo">Designed by zozo | </a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo | </a>
        <a href="https://beian.miit.gov.cn/">苏ICP备17028833号-3</a>
    </div>

    <div class="footer_slogan">
        <span>君子终日乾乾，夕惕若厉，无咎。</span>
        
    </div>

    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?7256012830beb794d5f4468b53b5891e";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
        
</footer>
    <script src="https://yokonsan.com/js/jquery-3.5.1.min.js"></script>
<link href="https://yokonsan.com/css/fancybox.min.css" rel="stylesheet">
<script src="https://yokonsan.com/js/fancybox.min.js"></script>
<script src="https://yokonsan.com/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



</body>

</html>